name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹ (major/minor/patch)'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      dry_run:
        description: 'ä»…é¢„è§ˆï¼Œä¸å®é™…åˆ›å»º tag'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: è·å–æœ€æ–° tag
        id: get_latest_tag
        run: |
          # è·å–æœ€æ–°çš„ tagï¼ˆæŒ‰ç‰ˆæœ¬å·æ’åºï¼‰
          latest_tag=$(git tag -l "v*.*.*" | sort -V | tail -n 1)
          
          if [ -z "$latest_tag" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°ç°æœ‰ tagï¼Œå°†ä» v0.0.0 å¼€å§‹"
            latest_tag="v0.0.0"
          fi
          
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ æœ€æ–° tag: $latest_tag"

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        id: check_changes
        run: |
          latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"
          
          if [ "$latest_tag" = "v0.0.0" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… é¦–æ¬¡å‘å¸ƒï¼Œè·³è¿‡å˜åŒ–æ£€æŸ¥"
            exit 0
          fi
          
          # æ¯”è¾ƒ master å’Œæœ€æ–° tag ä¹‹é—´çš„å·®å¼‚
          changes=$(git log ${latest_tag}..HEAD --oneline)
          
          if [ -z "$changes" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
            echo "::warning::master åˆ†æ”¯å’Œæœ€æ–° tag ${latest_tag} ä¹‹é—´æ²¡æœ‰æ–°çš„æäº¤"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°ä»¥ä¸‹å˜åŒ–:"
            echo "$changes"
            echo ""
            echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
            git diff --shortstat ${latest_tag}..HEAD
          fi

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: new_version
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"
          version_type="${{ github.event.inputs.version_type }}"
          
          # ç§»é™¤ 'v' å‰ç¼€
          version=${latest_tag#v}
          
          # åˆ†è§£ç‰ˆæœ¬å·
          IFS='.' read -r major minor patch <<< "$version"
          
          # æ ¹æ®ç‰ˆæœ¬ç±»å‹é€’å¢
          case "$version_type" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          new_version="v${major}.${minor}.${patch}"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "ğŸ¯ æ–°ç‰ˆæœ¬: $new_version"

      - name: è¿è¡Œæµ‹è¯•
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'false'
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
          go test -v ./workflow/...

      - name: é¢„è§ˆæ¨¡å¼ - æ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œ
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” é¢„è§ˆæ¨¡å¼ - ä¸ä¼šå®é™…åˆ›å»º tag"
          echo ""
          echo "ğŸ“‹ å°†è¦æ‰§è¡Œçš„æ“ä½œ:"
          echo "  - å½“å‰æœ€æ–° tag: ${{ steps.get_latest_tag.outputs.latest_tag }}"
          echo "  - æ˜¯å¦æœ‰å˜åŒ–: ${{ steps.check_changes.outputs.has_changes }}"
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "  - å°†åˆ›å»ºæ–° tag: ${{ steps.new_version.outputs.new_version }}"
          else
            echo "  - æ— éœ€åˆ›å»ºæ–° tag"
          fi

      - name: åˆ›å»ºå¹¶æ¨é€æ–° tag
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'false'
        run: |
          new_version="${{ steps.new_version.outputs.new_version }}"
          
          echo "ğŸ·ï¸  åˆ›å»ºæ–° tag: $new_version"
          git tag -a "$new_version" -m "Release $new_version"
          git push origin "$new_version"
          
          echo "âœ… Tag $new_version å·²åˆ›å»ºå¹¶æ¨é€"

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'false'
        run: |
          latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"
          new_version="${{ steps.new_version.outputs.new_version }}"
          
          echo "## ğŸ“ æ›´æ–°å†…å®¹" > changelog.md
          echo "" >> changelog.md
          
          if [ "$latest_tag" != "v0.0.0" ]; then
            echo "**å®Œæ•´å˜æ›´:** ${latest_tag}...${new_version}" >> changelog.md
            echo "" >> changelog.md
            
            # æå–æäº¤ä¿¡æ¯
            git log ${latest_tag}..HEAD --pretty=format:"- %s (%h)" >> changelog.md
            echo "" >> changelog.md
            echo "" >> changelog.md
            
            # ç»Ÿè®¡ä¿¡æ¯
            echo "## ğŸ“Š ç»Ÿè®¡" >> changelog.md
            git diff --shortstat ${latest_tag}..HEAD >> changelog.md
          else
            echo "ğŸ‰ é¦–æ¬¡å‘å¸ƒ" >> changelog.md
          fi
          
          cat changelog.md

      - name: åˆ›å»º GitHub Release
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.new_version.outputs.new_version }}
          name: Release ${{ steps.new_version.outputs.new_version }}
          body_path: changelog.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ€»ç»“
        if: always()
        run: |
          echo "## ğŸ‰ Release å·¥ä½œæµæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡å¼**: ${{ github.event.inputs.dry_run == 'true' && 'ğŸ” é¢„è§ˆæ¨¡å¼' || 'âœ… æ­£å¼å‘å¸ƒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬ç±»å‹**: ${{ github.event.inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€æ–° tag**: ${{ steps.get_latest_tag.outputs.latest_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¯å¦æœ‰å˜åŒ–**: ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "- **æ–°ç‰ˆæœ¬**: ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event.inputs.dry_run }}" = "false" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Release ${{ steps.new_version.outputs.new_version }} å·²æˆåŠŸåˆ›å»ºï¼**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ **æ— éœ€å‘å¸ƒæ–°ç‰ˆæœ¬**" >> $GITHUB_STEP_SUMMARY
          fi